@model PagedList.IPagedList<PayrollSystem.Models.JobOrderPayrollModel>
@using PagedList.Mvc;

    <table class="table table-striped table-bordered">
        <tr>
            <th>ID NO</th>
            <th>FIRST NAME</th>
            <th>LAST NAME</th>
            <th>FROM</th>
            <th>TO</th>
            <th></th>
        </tr>
        @foreach (var item in Model)
            {
            <tr>
                <td>
                    @Html.DisplayFor(modelItem => item.Employee.ID)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Employee.Firstname)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Employee.Lastname)
                </td>
                <td>
                  @Html.DisplayFor(modelItem => item.StartDate)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.EndDate)
                </td>
                <td class="hidden">
                    @Html.DisplayFor(modelItem => item.Id)
                </td>
                <td>
                  
                    
                  
                    @using (Html.BeginForm("CreateJoPayslip", "Report", FormMethod.Post))
                    {
                        <input type="hidden" name="fullnames" id="fullnames" value="@(item.Employee.Firstname+" "+item.Employee.Middlename+" "+item.Employee.Lastname)" />
                        <input type="hidden" name="designation" value="@item.Employee.Designation" />
                        <input type="hidden" name="date_from" value="@item.StartDate" />
                        <input type="hidden" name="date_to" value="@item.EndDate" />
                        <button type="button" class="btn btn-xs btn-danger remove-payroll-list" value="@item.Id"><i class="glyphicon glyphicon-trash"></i></button>
                        <button type="submit" name="id" id="emp_id" formtarget="_blank" class="btn btn-xs btn-primary td-button" value="@item.Employee.ID"><i class="glyphicon glyphicon-book"></i></button>
                    }
                </td>
            </tr>
        }
    </table>
    <div class="box-footer-jo-payroll-list">
        Page @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) of @Model.PageCount

        @Html.PagedListPager(Model, page => Url.Action("Index",
 new { page, sortOrder = ViewBag.CurrentSort, currentFilter = ViewBag.CurrentFilter }))
    </div>

    <script>

        $(document).ready(function () {

            $(".remove-payroll-list").click(function () {

                var empID = $(this).closest('tr').find('td:eq(0)').text().trim();
                var firstname = $(this).closest('tr').find('td:eq(1)').text().trim();
                var lastname = $(this).closest('tr').find('td:eq(3)').text().trim();

                deletePayrollByID($(this).val(),empID,firstname,lastname);
            });

            $("body").on("click", ".box-footer-jo-payroll-list li", function (e) {
                e.preventDefault();

                var page = $(this).text();
                if (page === "»") page = @Model.PageCount;
                if (page === "«") page = 1;

                var empID = $("#emp_id").val();
                var firstname = $("#fullnames").val().split(" ")[0];
                var lastname = $("#fullnames").val().split(" ")[2];

                loadJoPayrollList(page, empID, firstname, lastname);
            });

        });

        function loadJoPayrollList(page,empID,firstname,lastname) {

            var url = "@Url.Action("JobOrderPayrollList", "PartialView")";
            $(".parent-payroll-list").html("Loading data ...");

            $.ajax({
                url: url,
                type: "POST",
                data: {
                    page: page,
                    empID:empID,
                    firstname: firstname,
                    lastname: lastname,
                    middlename:""
                },
                success: function (html) {
                    $(".parent-payroll-list").html(html);
                }
            });
        }

        function deletePayrollByID(id,empID,firstname,lastname) {

            var url = "@Url.Action("DeleteJoPayroll", "Home")";

            $.ajax({
                url: url,
                type: "POST",
                data: {
                    id: id
                },
                success: function (flag) {
                    if (flag) {
                        $.toast({
                            heading: 'Success',
                            text: 'Payroll ID: '+id+' deleted.',
                            icon: 'success'
                        });
                        var empID = $("#emp_id").val();
                        var firstname = $("#fullnames").val().split(" ")[0];
                        var lastname = $("#fullnames").val().split(" ")[2];

                        loadJoPayrollList(1, empID, firstname, lastname);
                            
                    } else {
                        $.toast({
                            heading: 'Error',
                            text: 'Something went wrong, please contact system administrator',
                            icon: 'error'
                        });   
                    }
                        
                }
            });
        }


    </script>

    

